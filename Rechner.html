<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rechner – Smart Taschenrechner</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

  <style>
    /* ========= Light Mode Lesbarkeit fix ========= */
    [data-theme="light"] body { color: rgba(15,23,42,0.92); }
    [data-theme="light"] .liquid-glass{
      background: rgba(255,255,255,0.70) !important;
      border-color: rgba(15,23,42,0.10) !important;
      box-shadow: 0 10px 30px rgba(2,6,23,0.10) !important;
      color: rgba(15,23,42,0.92) !important;
    }
    [data-theme="light"] .text-white{ color: rgba(15,23,42,0.92) !important; }
    [data-theme="light"] .text-white\/85{ color: rgba(15,23,42,0.85) !important; }
    [data-theme="light"] .text-white\/75{ color: rgba(15,23,42,0.78) !important; }
    [data-theme="light"] .text-white\/70{ color: rgba(15,23,42,0.70) !important; }
    [data-theme="light"] .text-white\/60{ color: rgba(15,23,42,0.60) !important; }

    [data-theme="light"] .bg-white\/5{ background: rgba(2,6,23,0.04) !important; }
    [data-theme="light"] .border-white\/10{ border-color: rgba(15,23,42,0.14) !important; }
    [data-theme="light"] .focus\:border-white\/20:focus{ border-color: rgba(15,23,42,0.22) !important; }
    [data-theme="light"] .focus\:ring-white\/10:focus{ --tw-ring-color: rgba(2,6,23,0.10) !important; }

    [data-theme="light"] .lg-badge,
    [data-theme="light"] .lg-chip{
      background: rgba(2,6,23,0.06) !important;
      border-color: rgba(15,23,42,0.10) !important;
      color: rgba(15,23,42,0.78) !important;
    }

    .hidden{ display:none !important; }
    .scroll-mt-24 { scroll-margin-top: 7rem; }

    /* Optional fallback progress bar */
    #scrollProgress{
      position: fixed; top: 0; left: 0; height: 3px; width: 0%;
      background: rgba(56,189,248,.85);
      z-index: 99999;
    }

    /* “Rechner”-Inputs: einheitlich */
    .calc-input{
      width:100%;
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.92);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
    }
    .calc-input:focus{
      border-color: rgba(255,255,255,0.20);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.06);
    }
    [data-theme="light"] .calc-input{
      background: rgba(2,6,23,0.04) !important;
      color: rgba(15,23,42,0.92) !important;
      border-color: rgba(15,23,42,0.14) !important;
    }
    [data-theme="light"] .calc-input:focus{
      border-color: rgba(15,23,42,0.22) !important;
      box-shadow: 0 0 0 3px rgba(2,6,23,0.08) !important;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
    }
    [data-theme="light"] .pill{
      border-color: rgba(15,23,42,0.12);
      background: rgba(2,6,23,0.04);
    }
  </style>
</head>

<body class="app">
  <!-- SVG Filter: “liquid / distortion” -->
  <svg class="svg-filters" width="0" height="0" aria-hidden="true" focusable="false">
    <filter id="glass-distortion">
      <feTurbulence type="fractalNoise" baseFrequency="0.012" numOctaves="2" seed="8" result="noise"/>
      <feDisplacementMap in="SourceGraphic" in2="noise" scale="14" xChannelSelector="R" yChannelSelector="G"/>
    </filter>
  </svg>

  <main class="page-wrap">
    <div class="max-w-5xl mx-auto p-5">

      <!-- Widgets -->
      <section class="liquid-glass lg-surface lg-radius-xl p-3 md:p-4 mb-6">
        <div class="flex flex-wrap items-center gap-2 md:gap-4">
          <div class="liquid-glass lg-chip lg-radius-md p-2.5 flex items-center gap-2.5">
            <div class="lg-icon"><i data-feather="calendar" class="w-4 h-4"></i></div>
            <div>
              <p class="lg-muted m-0">Date</p>
              <div class="font-extrabold" id="date">–</div>
            </div>
          </div>

          <div class="liquid-glass lg-chip lg-radius-md p-2.5 flex items-center gap-2.5">
            <div class="lg-icon"><i data-feather="clock" class="w-4 h-4"></i></div>
            <div>
              <p class="lg-muted m-0">Time</p>
              <div class="font-extrabold" id="time">–</div>
            </div>
          </div>

          <div class="lg-divider"></div>

          <div class="liquid-glass lg-chip lg-radius-md p-2.5 flex items-center gap-2.5">
            <div class="lg-icon"><i data-feather="cloud" class="w-4 h-4"></i></div>
            <div>
              <p class="lg-muted m-0">Weather · Bern</p>
              <div class="font-extrabold"><span id="wxText">–</span> · <span id="wxTemp">–°C</span></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Search (optional: filter Text im Rechner, nicht zwingend aber gleiches Layout) -->
      <section class="liquid-glass lg-surface lg-radius-xl p-3 md:p-4 mb-6 sticky top-2 md:top-4 z-20">
        <div class="flex flex-wrap items-center gap-2 md:gap-4">
          <div class="relative flex-1 min-w-[220px]">
            <i data-feather="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-white/60 w-4 h-4"></i>
            <input id="q" type="search" placeholder="Suche (z. B. Bremsweg, Druck, Reifen...)"
              class="w-full bg-white/5 text-white border border-white/10 rounded-lg pl-9 pr-3 py-2.5 focus:outline-none focus:border-white/20 focus:ring-1 focus:ring-white/10">
          </div>

          <div class="flex gap-2">
            <span class="pill text-sm text-white/70">
              <i data-feather="cpu" class="w-4 h-4"></i>
              <span>Smart-Rechner</span>
            </span>
          </div>
        </div>
      </section>

      <!-- Overview -->
      <section id="overview" class="scroll-mt-24">
        <div class="flex items-center justify-between mb-4">
          <h1 class="text-2xl sm:text-3xl font-bold">Rechner</h1>
        </div>

        <!-- One clean card -->
        <div class="grid grid-cols-1 gap-4">
          <article class="liquid-glass lg-card lg-radius-lg p-4 flex flex-col gap-2.5">
            <div class="flex items-center gap-2 text-white/70">
              <i data-feather="zap" class="w-4 h-4"></i><span class="text-sm">Ein Rechner statt 8 Baustellen</span>
            </div>
            <h2 class="text-lg font-bold m-0">Cooler Taschenrechner</h2>
            <p class="text-white/75 m-0">
              Wähle aus, was du berechnen willst. Gib nur die Zahlen ein. Ergebnis erscheint live.
            </p>
            <a class="lg-open mt-auto" href="#calc">Öffnen <i data-feather="arrow-right" class="w-4 h-4"></i></a>
          </article>
        </div>
      </section>

      <!-- Smart Calculator -->
      <section id="calc" class="mt-6 scroll-mt-24">
        <div class="liquid-glass lg-surface lg-radius-xl p-4 md:p-5">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
            <div>
              <h2 class="text-xl font-bold mb-1 flex items-center gap-2">
                <i data-feather="cpu" class="w-5 h-5 text-sky-300"></i>
                <span>Smart Taschenrechner</span>
              </h2>
              <p class="text-white/60 text-sm m-0" id="calcDesc">–</p>
            </div>

            <div class="min-w-[240px]">
              <label class="text-white/70 text-xs">Was willst du berechnen?</label>
              <select id="calcType" class="calc-input mt-1">
                <option value="tyre">Reifen: Außen-Ø & Umfang</option>
                <option value="brake">Bremsweg: Reaktion + Bremsung</option>
                <option value="rpm">Geschwindigkeit aus Raddrehzahl</option>
                <option value="curve">Fliehkraft in Kurve</option>
                <option value="pressureP">Druck aus Kraft & Fläche (P=F/A)</option>
                <option value="pressureF">Kraft aus Druck & Fläche (F=P·A)</option>
                <option value="torqueM">Drehmoment aus Kraft & Hebelarm (M=F·r)</option>
                <option value="torqueF">Kraft aus Drehmoment & Hebelarm (F=M/r)</option>
                <option value="noise">Lärm: max. Zeit aus dB(A)</option>
                <option value="aq">Aquaplaning: vₐq aus Reifendruck</option>
                <option value="units">Einheiten umrechnen (Länge/Fläche/Volumen)</option>
              </select>
            </div>
          </div>

          <!-- Inputs -->
          <div id="fields" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>

          <!-- Output -->
          <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-3">
            <div class="liquid-glass lg-card lg-radius-lg p-4">
              <div class="text-white/60 text-xs mb-1">Ergebnis</div>
              <div class="text-2xl font-extrabold" id="resultMain">–</div>
              <div class="text-white/70 text-sm mt-2" id="resultSub">–</div>
            </div>
            <div class="liquid-glass lg-card lg-radius-lg p-4">
              <div class="text-white/60 text-xs mb-1">Formel (kurz)</div>
              <div class="text-white/75 text-sm" id="formula">–</div>

              <details class="mt-3">
                <summary class="text-white/70 text-sm cursor-pointer">Details anzeigen</summary>
                <pre class="text-white/75 text-sm mt-2 whitespace-pre-wrap" id="details">–</pre>
              </details>
            </div>
          </div>

          <div class="mt-4 flex flex-wrap gap-2">
            <button id="resetCalc" class="lg-btn">
              <i data-feather="rotate-ccw" class="w-4 h-4"></i><span>Reset Werte</span>
            </button>
            <span class="pill text-xs text-white/60">
              <i data-feather="smartphone" class="w-4 h-4"></i>
              <span>Mobile: Einfache Inputs, kein Tabellenchaos</span>
            </span>
          </div>
        </div>
      </section>

      <div class="text-white/60 text-xs text-center my-10">
        <div class="liquid-glass lg-chip lg-radius-pill inline-flex items-center gap-2 px-4 py-2">
          <span>© LearnCraft Pro</span>
          <span class="w-1 h-1 rounded-full bg-white/30"></span>
          <span>Rechner</span>
        </div>
      </div>

    </div>
  </main>

  <!-- Bottom Bar: NUR 3 Buttons -->
  <nav id="bottomBar" class="liquid-glass bottom-bar lg-radius-pill" aria-label="Navigation">
    <a class="bar-item active" href="Index.html" aria-label="Home">
      <i data-feather="home" class="bar-icon"></i>
      <span class="bar-label">Home</span>
    </a>

    <a class="bar-item" href="#overview" data-target="overview" aria-label="Übersicht">
      <i data-feather="grid" class="bar-icon"></i>
      <span class="bar-label">Übersicht</span>
    </a>

    <button id="themeToggle" class="bar-item" type="button" aria-label="Theme wechseln">
      <i id="themeIcon" data-feather="sun" class="bar-icon"></i>
      <span class="bar-label">Theme</span>
    </button>
  </nav>

  <div id="scrollProgress"></div>

  <script>
    /* ========= Helpers ========= */
    const $ = (s, r=document) => r.querySelector(s);
    const fmt = (n, d=2) => (Number.isFinite(n) ? n.toFixed(d).replace('.', ',') : '–');
    const num = (v) => {
      const x = parseFloat(String(v ?? '').replace(',', '.'));
      return Number.isFinite(x) ? x : NaN;
    };

    function normalize(text) {
      return (text || '').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
    }

    /* ========= Icons ========= */
    document.addEventListener('DOMContentLoaded', () => {
      if (window.feather) feather.replace();
    });

    /* ========= Theme ========= */
    (function themeInit(){
      const html = document.documentElement;
      const btn = document.getElementById('themeToggle');
      const icon = document.getElementById('themeIcon');

      function applyTheme(mode){
        html.setAttribute('data-theme', mode);
        localStorage.setItem('theme', mode);
        if (icon) icon.setAttribute('data-feather', mode === 'dark' ? 'sun' : 'moon');
        if (window.feather) feather.replace();
      }
      applyTheme(localStorage.getItem('theme') || 'dark');
      btn?.addEventListener('click', () => {
        const current = html.getAttribute('data-theme') || 'dark';
        applyTheme(current === 'dark' ? 'light' : 'dark');
      });
    })();

    /* ========= Date/Time ========= */
    function updateDateTime() {
      const now = new Date();
      const d = document.getElementById('date');
      const t = document.getElementById('time');
      if (d) d.textContent = now.toLocaleDateString('de-CH', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
      if (t) t.textContent = now.toLocaleTimeString('de-CH');
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    /* ========= Weather (simple) ========= */
    async function fetchWeather(){
      try{
        const res = await fetch('https://wttr.in/Bern?format=%25C|%25t', {cache:'no-store'});
        const text = await res.text();
        const [c,temp] = (text||'').split('|');
        const wxT = document.getElementById('wxText');
        const wxTemp = document.getElementById('wxTemp');
        if (wxT) wxT.textContent = c || '–';
        if (wxTemp) wxTemp.textContent = (temp||'–').replace('+','');
      }catch(e){}
    }
    fetchWeather();

    /* ========= Scroll Progress ========= */
    (function(){
      const progress = document.getElementById('scrollProgress');
      const onScroll = () => {
        const h = document.documentElement;
        const denom = (h.scrollHeight - h.clientHeight) || 1;
        progress.style.width = (h.scrollTop / denom * 100).toFixed(2) + '%';
      };
      document.addEventListener('scroll', onScroll, {passive:true});
      onScroll();
    })();

    /* ========= Smart Calculator Config ========= */
    const CALCS = {
      tyre: {
        title: "Reifen: Außen-Ø & Umfang",
        desc: "Breite, Höhe (%), Felge (Zoll) eingeben. Du bekommst Ø, Umfang und Flankenhöhe.",
        formula: "h = w·(q/100), dᵢ = Zoll·25,4, dₒ = dᵢ + 2h, U = π·dₒ",
        defaults: { w: 205, q: 60, rim: 16 },
        fields: [
          { id:"w", label:"Breite (mm)", type:"number", step:"1" },
          { id:"q", label:"Höhe (%)", type:"number", step:"1" },
          { id:"rim", label:"Felge (Zoll)", type:"number", step:"0.5" }
        ],
        compute: (v) => {
          const w = num(v.w), q = num(v.q), rim = num(v.rim);
          if(!(w>0 && q>0 && rim>0)) return null;
          const h = w*(q/100);
          const di = rim*25.4;
          const do_ = di + 2*h;
          const U = Math.PI*do_;
          return {
            main: `${fmt(do_,0)} mm`,
            sub: `Umfang: ${fmt(U/1000,3)} m · Flankenhöhe: ${fmt(h,1)} mm · Innen-Ø: ${fmt(di,1)} mm`,
            details:
`h = ${w}·(${q}/100) = ${h.toFixed(2)} mm
dᵢ = ${rim}·25,4 = ${di.toFixed(2)} mm
dₒ = ${di.toFixed(2)} + 2·${h.toFixed(2)} = ${do_.toFixed(2)} mm
U = π·${do_.toFixed(2)} = ${U.toFixed(2)} mm = ${(U/1000).toFixed(3)} m`
          };
        }
      },

      brake: {
        title: "Bremsweg: Reaktion + Bremsung",
        desc: "v, Reaktionszeit und Reibwert µ. Ergebnis: Reaktionsweg, Bremsweg, Anhalteweg.",
        formula: "v(m/s)=v(km/h)/3,6 · sᵣ=v·t · sᵦ=v²/(2·µ·g), g=9,81",
        defaults: { v: 100, t: 1.0, mu: 0.8 },
        fields: [
          { id:"v", label:"Geschwindigkeit (km/h)", type:"number", step:"1" },
          { id:"t", label:"Reaktionszeit (s)", type:"number", step:"0.1" },
          { id:"mu", label:"Reibwert µ (trocken≈0,8 / nass≈0,5)", type:"number", step:"0.01" }
        ],
        compute: (v) => {
          const vkmh = num(v.v), t = num(v.t), mu = num(v.mu);
          if(!(vkmh>=0 && t>=0 && mu>0)) return null;
          const g = 9.81;
          const vms = vkmh/3.6;
          const sR = vms*t;
          const sB = (vms*vms)/(2*mu*g);
          const sT = sR+sB;
          return {
            main: `${fmt(sT,1)} m`,
            sub: `Reaktion: ${fmt(sR,1)} m · Bremsweg: ${fmt(sB,1)} m`,
            details:
`v = ${vkmh}/3,6 = ${vms.toFixed(2)} m/s
sᵣ = v·t = ${vms.toFixed(2)}·${t} = ${sR.toFixed(2)} m
sᵦ = v²/(2·µ·g) = ${vms.toFixed(2)}²/(2·${mu}·9,81) = ${sB.toFixed(2)} m
s = ${sT.toFixed(2)} m`
          };
        }
      },

      rpm: {
        title: "Geschwindigkeit aus Raddrehzahl",
        desc: "Drehzahl n (1/min) und Abrollumfang U (m). Ergebnis: v in km/h und m/s.",
        formula: "v(km/h)= n·U·60 / 1000",
        defaults: { n: 600, U: 1.99 },
        fields: [
          { id:"n", label:"Raddrehzahl n (1/min)", type:"number", step:"1" },
          { id:"U", label:"Umfang U (m)", type:"number", step:"0.001" }
        ],
        compute: (v) => {
          const n = num(v.n), U = num(v.U);
          if(!(n>=0 && U>0)) return null;
          const v_kmh = n*U*60/1000;
          const v_ms = v_kmh/3.6;
          return {
            main: `${fmt(v_kmh,2)} km/h`,
            sub: `${fmt(v_ms,2)} m/s`,
            details: `v = ${n}·${U}·60/1000 = ${v_kmh.toFixed(3)} km/h`
          };
        }
      },

      curve: {
        title: "Fliehkraft in Kurve",
        desc: "v, Masse m, Kurvenradius r. Optional µ, um max. Haftkraft zu sehen.",
        formula: "a=v²/r · F=m·a · F_max≈µ·m·g",
        defaults: { v: 80, unit: "kmh", m: 1500, r: 100, mu: 0.8 },
        fields: [
          { id:"v", label:"Geschwindigkeit", type:"number", step:"1" },
          { id:"unit", label:"Einheit", type:"select", options:[["kmh","km/h"],["ms","m/s"]] },
          { id:"m", label:"Masse m (kg)", type:"number", step:"1" },
          { id:"r", label:"Radius r (m)", type:"number", step:"1" },
          { id:"mu", label:"Reibwert µ (optional)", type:"number", step:"0.01" }
        ],
        compute: (v) => {
          let sp = num(v.v);
          const unit = v.unit || "kmh";
          const m = num(v.m), r = num(v.r);
          const mu = num(v.mu);
          if(!(sp>=0 && m>0 && r>0)) return null;
          if(unit==="kmh") sp = sp/3.6;
          const a = (sp*sp)/r;
          const F = m*a;
          const g = 9.81;
          const hasMu = (mu>0);
          const Fmax = hasMu ? (mu*m*g) : NaN;
          return {
            main: `${fmt(F,0)} N`,
            sub: `a: ${fmt(a,2)} m/s²${hasMu ? ` · max≈${fmt(Fmax,0)} N` : ""}`,
            details:
`v = ${unit==="kmh" ? (num(v.v).toFixed(2)+" km/h → "+sp.toFixed(2)+" m/s") : (sp.toFixed(2)+" m/s")}
a = v²/r = ${sp.toFixed(2)}²/${r} = ${a.toFixed(4)} m/s²
F = m·a = ${m}·${a.toFixed(4)} = ${F.toFixed(2)} N` + (hasMu ? `\nF_max ≈ µ·m·g = ${mu}·${m}·9,81 = ${Fmax.toFixed(2)} N` : "")
          };
        }
      },

      pressureP: {
        title: "Druck aus Kraft & Fläche",
        desc: "Gib Kraft F und Fläche A ein. Ergebnis: Druck P in bar und Pa.",
        formula: "P = F/A · (1 bar = 100'000 Pa)",
        defaults: { F: 5000, A: 0.01 },
        fields: [
          { id:"F", label:"Kraft F (N)", type:"number", step:"1" },
          { id:"A", label:"Fläche A (m²)", type:"number", step:"0.0001" }
        ],
        compute: (v) => {
          const F = num(v.F), A = num(v.A);
          if(!(F>0 && A>0)) return null;
          const P = F/A;          // Pa
          const bar = P/1e5;
          return {
            main: `${fmt(bar,3)} bar`,
            sub: `${fmt(P,0)} Pa`,
            details: `P = ${F}/${A} = ${P.toFixed(2)} Pa = ${(P/1e5).toFixed(5)} bar`
          };
        }
      },

      pressureF: {
        title: "Kraft aus Druck & Fläche",
        desc: "Gib Druck P (bar) und Fläche A (m²) ein. Ergebnis: Kraft F.",
        formula: "F = P·A · (1 bar = 100'000 Pa)",
        defaults: { Pbar: 2.0, A: 0.01 },
        fields: [
          { id:"Pbar", label:"Druck P (bar)", type:"number", step:"0.01" },
          { id:"A", label:"Fläche A (m²)", type:"number", step:"0.0001" }
        ],
        compute: (v) => {
          const Pbar = num(v.Pbar), A = num(v.A);
          if(!(Pbar>0 && A>0)) return null;
          const P = Pbar*1e5;
          const F = P*A;
          return {
            main: `${fmt(F,0)} N`,
            sub: `${fmt(F/1000,2)} kN`,
            details: `F = ( ${Pbar} bar → ${P.toFixed(0)} Pa ) · ${A} = ${F.toFixed(2)} N`
          };
        }
      },

      torqueM: {
        title: "Drehmoment aus Kraft & Hebelarm",
        desc: "Gib Kraft F und Hebelarm r ein. Ergebnis: Drehmoment M.",
        formula: "M = F·r",
        defaults: { F: 300, r: 0.5 },
        fields: [
          { id:"F", label:"Kraft F (N)", type:"number", step:"1" },
          { id:"r", label:"Hebelarm r (m)", type:"number", step:"0.001" }
        ],
        compute: (v) => {
          const F = num(v.F), r = num(v.r);
          if(!(F>0 && r>0)) return null;
          const M = F*r;
          return {
            main: `${fmt(M,2)} N·m`,
            sub: `F: ${fmt(F,0)} N · r: ${fmt(r,3)} m`,
            details: `M = ${F}·${r} = ${M.toFixed(4)} N·m`
          };
        }
      },

      torqueF: {
        title: "Kraft aus Drehmoment & Hebelarm",
        desc: "Gib Drehmoment M und Hebelarm r ein. Ergebnis: Kraft F.",
        formula: "F = M/r",
        defaults: { M: 120, r: 0.3 },
        fields: [
          { id:"M", label:"Drehmoment M (N·m)", type:"number", step:"0.1" },
          { id:"r", label:"Hebelarm r (m)", type:"number", step:"0.001" }
        ],
        compute: (v) => {
          const M = num(v.M), r = num(v.r);
          if(!(M>0 && r>0)) return null;
          const F = M/r;
          return {
            main: `${fmt(F,2)} N`,
            sub: `${fmt(F/9.81,1)} kg (ungefähr, Gewichtskraft)`,
            details: `F = ${M}/${r} = ${F.toFixed(4)} N`
          };
        }
      },

      noise: {
        title: "Lärm: max. Zeit aus dB(A)",
        desc: "Grobmodell: 85 dB = 8h, jede +3 dB halbiert die Zeit.",
        formula: "T = 8h · 0,5^((dB−85)/3)",
        defaults: { db: 95 },
        fields: [
          { id:"db", label:"Pegel (dB(A))", type:"number", step:"1" }
        ],
        compute: (v) => {
          const db = num(v.db);
          if(!(db>0)) return null;
          const steps = (db-85)/3;
          const hours = 8*Math.pow(0.5, steps);
          const totalMin = Math.max(0, Math.round(hours*60));
          const h = Math.floor(totalMin/60);
          const m = totalMin%60;
          const nice = (h? `${h} h `:"") + `${m} min`;
          return {
            main: `${nice}`,
            sub: `≈ ${fmt(hours,2)} h`,
            details: `T = 8·0,5^((${db}-85)/3) = ${hours.toFixed(4)} h`
          };
        }
      },

      aq: {
        title: "Aquaplaning: vₐq aus Reifendruck",
        desc: "Näherung: vₐq ≈ 63,4·√p(bar).",
        formula: "vₐq ≈ 63,4·√p",
        defaults: { p: 2.2 },
        fields: [
          { id:"p", label:"Reifendruck p (bar)", type:"number", step:"0.1" }
        ],
        compute: (v) => {
          const p = num(v.p);
          if(!(p>0)) return null;
          const vaq = 63.4*Math.sqrt(p);
          return {
            main: `${fmt(vaq,1)} km/h`,
            sub: `bei p=${fmt(p,1)} bar`,
            details: `vₐq = 63,4·√${p} = ${vaq.toFixed(3)} km/h`
          };
        }
      },

      units: {
        title: "Einheiten umrechnen",
        desc: "Wähle Typ, gib Wert ein, wähle Einheit. Ergebnis erscheint sofort in allen Einheiten.",
        formula: "Konvertiere alles auf Basiseinheit (m / m² / m³), dann zurück.",
        defaults: { mode:"length", val: 1, from:"m" },
        fields: [
          { id:"mode", label:"Modus", type:"select", options:[["length","Länge"],["area","Fläche"],["volume","Volumen"]] },
          { id:"val", label:"Wert", type:"number", step:"0.0001" },
          { id:"from", label:"Einheit", type:"select", options:[["m","m"],["cm","cm"],["mm","mm"],["km","km"]] }
        ],
        onChangeFields: (values) => {
          const mode = values.mode || "length";
          if(mode==="length") return [["m","m"],["cm","cm"],["mm","mm"],["km","km"]];
          if(mode==="area")   return [["m2","m²"],["cm2","cm²"],["mm2","mm²"]];
          return [["m3","m³"],["L","L"],["cm3","cm³"],["mm3","mm³"]];
        },
        compute: (v) => {
          const mode = v.mode || "length";
          const val = num(v.val);
          const from = v.from;
          if(!Number.isFinite(val)) return null;

          let out = "";
          let details = "";

          if(mode==="length"){
            const m = from==="m" ? val : from==="cm" ? val/100 : from==="mm" ? val/1000 : from==="km" ? val*1000 : val;
            out = `m: ${fmt(m,4)} · cm: ${fmt(m*100,2)} · mm: ${fmt(m*1000,1)} · km: ${fmt(m/1000,6)}`;
            details = `Basiseinheit m = ${m}`;
            return { main: "Konvertiert", sub: out, details };
          }

          if(mode==="area"){
            const m2 = from==="m2" ? val : from==="cm2" ? val/1e4 : from==="mm2" ? val/1e6 : val;
            out = `m²: ${fmt(m2,6)} · cm²: ${fmt(m2*1e4,2)} · mm²: ${fmt(m2*1e6,1)}`;
            details = `Basiseinheit m² = ${m2}`;
            return { main: "Konvertiert", sub: out, details };
          }

          // volume
          const m3 = from==="m3" ? val : from==="L" ? val/1000 : from==="cm3" ? val/1e6 : from==="mm3" ? val/1e9 : val;
          out = `m³: ${fmt(m3,8)} · L: ${fmt(m3*1000,3)} · cm³: ${fmt(m3*1e6,1)} · mm³: ${fmt(m3*1e9,0)}`;
          details = `Basiseinheit m³ = ${m3}`;
          return { main: "Konvertiert", sub: out, details };
        }
      }
    };

    /* ========= Render fields ========= */
    const fieldsEl = $("#fields");
    const typeEl = $("#calcType");
    const descEl = $("#calcDesc");
    const formulaEl = $("#formula");
    const resultMain = $("#resultMain");
    const resultSub = $("#resultSub");
    const detailsEl = $("#details");
    const resetBtn = $("#resetCalc");
    const searchEl = $("#q");

    function setSelectOptions(select, options){
      select.innerHTML = "";
      options.forEach(([val, label]) => {
        const o = document.createElement("option");
        o.value = val; o.textContent = label;
        select.appendChild(o);
      });
    }

    function buildFields(calcKey){
      const cfg = CALCS[calcKey];
      if(!cfg) return;

      descEl.textContent = cfg.desc;
      formulaEl.textContent = cfg.formula;

      fieldsEl.innerHTML = "";
      const values = {...(cfg.defaults||{})};

      // Build inputs
      cfg.fields.forEach(f => {
        const wrap = document.createElement("div");
        wrap.className = "flex flex-col gap-1";

        const lab = document.createElement("label");
        lab.className = "text-white/70 text-xs";
        lab.textContent = f.label;

        let input;
        if(f.type === "select"){
          input = document.createElement("select");
          input.className = "calc-input";
          const opts = (f.options || []);
          setSelectOptions(input, opts);
          input.value = (values[f.id] ?? opts?.[0]?.[0] ?? "");
        } else {
          input = document.createElement("input");
          input.className = "calc-input";
          input.type = f.type || "number";
          if(f.step) input.step = f.step;
          input.value = (values[f.id] ?? "");
          input.inputMode = "decimal";
        }

        input.id = "f_" + f.id;
        wrap.appendChild(lab);
        wrap.appendChild(input);
        fieldsEl.appendChild(wrap);
      });

      // Special: units mode changes available "from"
      if(calcKey === "units"){
        const modeSel = $("#f_mode");
        const fromSel = $("#f_from");
        const cfgU = CALCS.units;

        function refreshFrom(){
          const valuesNow = getValues(calcKey);
          const opts = cfgU.onChangeFields(valuesNow);
          setSelectOptions(fromSel, opts);
          // try keep previous selection if exists
          if(opts.some(o => o[0] === valuesNow.from)) fromSel.value = valuesNow.from;
          else fromSel.value = opts[0][0];
          run(calcKey);
        }

        modeSel.addEventListener("change", refreshFrom);
        refreshFrom();
      }

      // Live update
      fieldsEl.querySelectorAll("input, select").forEach(el => {
        el.addEventListener("input", () => run(calcKey));
        el.addEventListener("change", () => run(calcKey));
      });

      run(calcKey);
    }

    function getValues(calcKey){
      const cfg = CALCS[calcKey];
      const out = {};
      cfg.fields.forEach(f => {
        const el = $("#f_" + f.id);
        out[f.id] = el ? el.value : "";
      });
      return out;
    }

    function run(calcKey){
      const cfg = CALCS[calcKey];
      const values = getValues(calcKey);
      const r = cfg.compute(values);

      if(!r){
        resultMain.textContent = "–";
        resultSub.textContent = "Bitte Werte prüfen.";
        detailsEl.textContent = "–";
        return;
      }
      resultMain.textContent = r.main ?? "–";
      resultSub.textContent = r.sub ?? "–";
      detailsEl.textContent = r.details ?? "–";
    }

    /* ========= Reset ========= */
    resetBtn.addEventListener("click", () => {
      const key = typeEl.value;
      const cfg = CALCS[key];
      if(!cfg) return;
      cfg.fields.forEach(f => {
        const el = $("#f_" + f.id);
        if(!el) return;

        if(f.type==="select"){
          // set to default if provided, else first option
          el.value = (cfg.defaults?.[f.id] ?? (f.options?.[0]?.[0] ?? el.value));
        } else {
          el.value = (cfg.defaults?.[f.id] ?? "");
        }
      });

      // Units: refresh options after reset
      if(key==="units"){
        const modeSel = $("#f_mode");
        modeSel.dispatchEvent(new Event("change"));
      } else {
        run(key);
      }
    });

    /* ========= Search: filter dropdown choices (simple) ========= */
    const allOptions = Array.from(typeEl.options).map(o => ({value:o.value, label:o.textContent}));
    searchEl.addEventListener("input", () => {
      const q = normalize(searchEl.value.trim());
      // rebuild options filtered
      typeEl.innerHTML = "";
      allOptions.forEach(opt => {
        const hit = !q || normalize(opt.label).includes(q);
        if(hit){
          const o = document.createElement("option");
          o.value = opt.value; o.textContent = opt.label;
          typeEl.appendChild(o);
        }
      });
      // keep valid selection
      if(!typeEl.value) typeEl.value = (typeEl.options[0]?.value || "tyre");
      buildFields(typeEl.value);
      if (window.feather) feather.replace();
    });

    /* ========= Init ========= */
    typeEl.addEventListener("change", () => buildFields(typeEl.value));
    buildFields(typeEl.value);

    /* ========= Bottom bar active state (only Overview highlight) ========= */
    (function barActive(){
      const overviewBtn = document.querySelector('#bottomBar a[data-target="overview"]');
      const overview = document.getElementById('overview');
      if (!overviewBtn || !overview) return;

      const obs = new IntersectionObserver((entries)=>{
        const v = entries[0];
        overviewBtn.classList.toggle('active', !!v?.isIntersecting);
      }, { rootMargin: '-40% 0px -55% 0px', threshold: 0.08 });

      obs.observe(overview);
    })();

    /* Smooth anchor */
    document.addEventListener('click', (e)=>{
      const a = e.target.closest('a[href^="#"]');
      if(!a) return;
      const id = a.getAttribute('href').slice(1);
      const el = document.getElementById(id);
      if(!el) return;
      e.preventDefault();
      el.scrollIntoView({behavior:'smooth', block:'start'});
    });
  </script>
</body>
</html>
